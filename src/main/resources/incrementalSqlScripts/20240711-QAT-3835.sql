INSERT INTO `em_email_template` (`EMAIL_DESC`, `SUBJECT`, `SUBJECT_PARAM`, `EMAIL_BODY`, `EMAIL_BODY_PARAM`, `CREATED_BY`, `CREATED_DATE`, `LAST_MODIFIED_BY`, `LAST_MODIFIED_DATE`, `ACTIVE`) VALUES ('Supply plan version and review process', '[QAT] <%PROGRAM%> Supply Plan does not need a review', 'PROGRAM', '', 'PROGRAM,VERSION,VERSION_COMMENTS', '1', '2024-07-12 00:00:00', '1', '2024-07-12 00:00:00', '1');
UPDATE `fasp`.`em_email_template` SET `EMAIL_BODY` = '<!doctype html>\n<html>\n  <head>\n    <meta name=\"viewport\" content=\"width=device-width\">\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n    <title>Default Template</title>\n    <style>\n    @media only screen and (max-width: 620px) {\n      table[class=body] h1 {\n        font-size: 28px !important;\n        margin-bottom: 10px !important;\n      }\n      table[class=body] p,\n            table[class=body] ul,\n            table[class=body] ol,\n            table[class=body] td,\n            table[class=body] span,\n            table[class=body] a {\n        font-size: 16px !important;\n      }\n      table[class=body] .wrapper,\n            table[class=body] .article {\n        padding: 10px !important;\n      }\n      table[class=body] .content {\n        padding: 0 !important;\n      }\n      table[class=body] .container {\n        padding: 0 !important;\n        width: 100% !important;\n      }\n      table[class=body] .main {\n        border-left-width: 0 !important;\n        border-radius: 0 !important;\n        border-right-width: 0 !important;\n      }\n      table[class=body] .btn table {\n        width: 100% !important;\n      }\n      table[class=body] .btn a {\n        width: 100% !important;\n      }\n      table[class=body] .img-responsive {\n        height: auto !important;\n        max-width: 100% !important;\n        width: auto !important;\n      }\n    }\n\n    /* -------------------------------------\n        PRESERVE THESE STYLES IN THE HEAD\n    ------------------------------------- */\n    @media all {\n      .ExternalClass {\n        width: 100%;\n      }\n      .ExternalClass,\n            .ExternalClass p,\n            .ExternalClass span,\n            .ExternalClass font,\n            .ExternalClass td,\n            .ExternalClass div {\n        line-height: 100%;\n      }\n      .apple-link a {\n        color: inherit !important;\n        font-family: inherit !important;\n        font-size: inherit !important;\n        font-weight: inherit !important;\n        line-height: inherit !important;\n        text-decoration: none !important;\n      }\n      #MessageViewBody a {\n        color: inherit;\n        text-decoration: none;\n        font-size: inherit;\n        font-family: inherit;\n        font-weight: inherit;\n        line-height: inherit;\n      }\n      .btn-primary table td:hover {\n        background-color: #34495e !important;\n      }\n      .btn-primary a:hover {\n        background-color: #34495e !important;\n        border-color: #34495e !important;\n      }\n    }\n    </style>\n  </head>\n  <body class=\"\" style=\"background-color: #f6f6f6; font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; line-height: 1.4; margin: 0; padding: 0; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;color: #222;\">\n    <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"body\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background-color: #f6f6f6;\">\n      <tr>\n        <td style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 14px; vertical-align: top;\">&nbsp;</td>\n        <td class=\"container\" style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 14px; vertical-align: top; display: block; Margin: 0 auto; max-width: 580px; padding: 10px; width: 580px;\">\n          <div class=\"content\" style=\"box-sizing: border-box; display: block; Margin: 0 auto; max-width: 580px; padding: 10px;\">\n\n            <!-- START CENTERED WHITE CONTAINER -->\n            <span class=\"preheader\" style=\"color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;\"><!-- This is preheader text. Some clients will show this text as a preview. --></span>\n            <table class=\"main\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #ffffff; border-radius: 3px;margin-top: 10px;\">\n\n              <!-- START MAIN CONTENT AREA -->\n              <tr>\n                <td class=\"wrapper\" style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 20px 40px;\">\n                  <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;\">\n                    <tr>\n                      <td align=\"center\" style=\"text-align: center;background-color: #bb3430\">\n                        <div class=\"pageicon\" style=\"overflow: hidden;padding-top:30px;\">\n                        </div>\n                        <h2 style=\"font-weight: 400;color: #fff;padding-bottom: 27px;border-bottom: 0px solid #c7c7c7;margin: 0px;\">\nSupply Plan Revision Notification\n                        </h2>\n                      </td>\n                    </tr>\n                    <tr>\n                      <td style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 14px; vertical-align: top;padding: 50px 20px 30px 20px;\">\n                        <p style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 18px; font-weight: 700; margin: 0; margin-bottom: 15px;\">Hello,</p>\n                        <p style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 15px; font-weight: normal; margin: 0; margin-bottom: 5px;\"></p>\n<p style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 15px; font-weight: normal; margin: 0; margin-bottom: 15px;\">\nThe supply plan for program <%PROGRAM%> version <%VERSION%> does not need to be Reviewed. \n</p>\n<p style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 15px; font-weight: normal; margin: 0; margin-bottom: 15px;\">\n<b>Version comments: <%VERSION_COMMENTS%></b>\n</p>\n<p style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 15px; font-weight: normal; margin: 0; margin-bottom: 15px;\">\nPlease log in to <a href=\"https://www.quantificationanalytics.org/#/login\">QAT</a> to review details.\n</p>\n<p style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 14px; font-weight: normal; margin: 0; margin-bottom: 15px;padding-bottom: 20px;\">\n                            Thanks,<br>\n    Quantification Analytics Tool<br>\n    (<b><i>I am a robot. Please do not reply to this email</i></b>) \n                        </p>\n                      </td>\n                    </tr>\n                  </table>\n                </td>\n              </tr>\n\n            <!-- END MAIN CONTENT AREA -->\n            </table>\n          <!-- END CENTERED WHITE CONTAINER -->\n          </div>\n        </td>\n        <td style=\"font-family: \'\'Roboto Slab\'\', \'\'Roboto\'\', \'\'Arial\'\', sans-serif; font-size: 14px; vertical-align: top;\">&nbsp;</td>\n      </tr>\n    </table>\n  </body>\n</html>' WHERE (`EMAIL_TEMPLATE_ID` = '8');


INSERT INTO ap_label VALUES (null, 'SP - Notification To NoReview', null, null, null, 1, now(), 1, now(), 24);
INSERT INTO us_business_function VALUES ('ROLE_BF_NOTIFICATION_TO_NOREVIEW', LAST_INSERT_ID(), 1, now(), 1, now());
INSERT INTO ap_label VALUES (null, 'SP - Notification To NoReview', null, null, null, 1, now(), 1, now(), 24);
INSERT INTO us_business_function VALUES ('ROLE_BF_NOTIFICATION_CC_NOREVIEW', LAST_INSERT_ID(), 1, now(), 1, now());
INSERT INTO ap_label VALUES (null, 'SP - Notification To NoReview', null, null, null, 1, now(), 1, now(), 24);
INSERT INTO us_business_function VALUES ('ROLE_BF_NOTIFICATION_BCC_NOREVIEW', LAST_INSERT_ID(), 1, now(), 1, now());

INSERT INTO us_role_business_function VALUES (null, 'ROLE_PROGRAM_ADMIN','ROLE_BF_NOTIFICATION_BCC_NOREVIEW', 1, now(), 1, now());
INSERT INTO us_role_business_function VALUES (null, 'ROLE_PROGRAM_USER','ROLE_BF_NOTIFICATION_BCC_NOREVIEW', 1, now(), 1, now());
INSERT INTO us_role_business_function VALUES (null, 'ROLE_SUPPLY_PLAN_REVIEWER','ROLE_BF_NOTIFICATION_BCC_NOREVIEW', 1, now(), 1, now());
INSERT INTO us_role_business_function VALUES (null, 'ROLE_REALM_ADMIN','ROLE_BF_NOTIFICATION_BCC_NOREVIEW', 1, now(), 1, now());

USE `fasp`;
DROP procedure IF EXISTS `getSupplyPlanNotificationToList`;

USE `fasp`;
DROP procedure IF EXISTS `fasp`.`getSupplyPlanNotificationToList`;
;

DELIMITER $$
USE `fasp`$$
CREATE DEFINER=`faspUser`@`%` PROCEDURE `getSupplyPlanNotificationToList`(VAR_PROGRAM_ID INT(10), VAR_VERSION_ID INT(10), VAR_STATUS_ID INT(10))
BEGIN
    -- This SP is only called for Final Supply Plan submissions not for Draft
    SET @programId = VAR_PROGRAM_ID;
    SET @versionId = VAR_VERSION_ID;
    SET @statusId = VAR_STATUS_ID;
    -- statusId = 1 -> Final Submitted
    -- statusId = 2 -> Final Approved 
    -- statusId = 3 -> Final Rejected
    -- statusId = 4 -> No review required
    SELECT pv.CREATED_BY `COMMITTED_BY`, pvt.LAST_MODIFIED_BY INTO @committedId, @approverId FROM rm_program_version pv LEFT JOIN rm_program_version_trans pvt ON pv.PROGRAM_VERSION_ID=pvt.PROGRAM_VERSION_ID AND pvt.VERSION_STATUS_ID=@statusId WHERE pv.PROGRAM_ID=@programId and pv.VERSION_ID=@versionId;
    
    IF @statusId=1 THEN
        -- Final submitted
        -- toList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID
        FROM vw_program p 
        LEFT JOIN us_user_acl acl ON 
            (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
            AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
            AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
            AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
        LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
        LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
        LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
        WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID='ROLE_BF_NOTIFICATION_TO_COMMIT' AND p.PROGRAM_ID=@programId AND u.ACTIVE
        GROUP BY u.USER_ID;

    ELSEIF @statusId=2 THEN
        -- Approved
        -- toList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID 
        FROM (
            SELECT u.USER_ID
            FROM vw_program p 
            LEFT JOIN us_user_acl acl ON 
                    (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
                    AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
                    AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
                    AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
            LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
            LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
            LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
            WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID='ROLE_BF_NOTIFICATION_TO_APPROVE' AND p.PROGRAM_ID=@programId AND u.ACTIVE

        UNION

            SELECT @committedId
        ) uTo
        LEFT JOIN us_user u ON uTo.USER_ID=u.USER_ID
        GROUP BY u.USER_ID;

    ELSEIF @statusId=3 THEN
        -- Rejected
        -- toList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID 
        FROM (
            SELECT u.USER_ID
            FROM vw_program p 
            LEFT JOIN us_user_acl acl ON 
                    (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
                    AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
                    AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
                    AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
            LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
            LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
            LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
            WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID='ROLE_BF_NOTIFICATION_TO_REJECT' AND p.PROGRAM_ID=@programId AND u.ACTIVE

        UNION

            SELECT @committedId
        ) uTo
        LEFT JOIN us_user u ON uTo.USER_ID=u.USER_ID
        GROUP BY u.USER_ID;

    ELSEIF @statusId=4 THEN
        -- No review required
        -- toList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID 
        FROM (
            SELECT u.USER_ID
            FROM vw_program p 
            LEFT JOIN us_user_acl acl ON 
                    (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
                    AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
                    AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
                    AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
            LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
            LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
            LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
            WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID='ROLE_BF_NOTIFICATION_TO_NOREVIEW' AND p.PROGRAM_ID=@programId AND u.ACTIVE

        UNION

            SELECT @committedId
        ) uTo
        LEFT JOIN us_user u ON uTo.USER_ID=u.USER_ID
        GROUP BY u.USER_ID;
    END IF; 
    
END$$

DELIMITER ;
;


USE `fasp`;
DROP procedure IF EXISTS `getSupplyPlanNotificationToList`;

USE `fasp`;
DROP procedure IF EXISTS `fasp`.`getSupplyPlanNotificationToList`;
;

DELIMITER $$
USE `fasp`$$
CREATE DEFINER=`faspUser`@`%` PROCEDURE `getSupplyPlanNotificationCcList`(VAR_PROGRAM_ID INT(10), VAR_VERSION_ID INT(10), VAR_STATUS_ID INT(10))
BEGIN
    -- This SP is only called for Final Supply Plan submissions not for Draft
    SET @programId = VAR_PROGRAM_ID;
    SET @versionId = VAR_VERSION_ID;
    SET @statusId = VAR_STATUS_ID;
    -- statusId = 1 -> Final Submitted
    -- statusId = 2 -> Final Approved
    -- statusId = 3 -> Final Rejected
    -- statusId = 3 -> No review required
    SELECT pv.CREATED_BY `COMMITTED_BY`, pvt.LAST_MODIFIED_BY INTO @committedId, @approverId FROM rm_program_version pv LEFT JOIN rm_program_version_trans pvt ON pv.PROGRAM_VERSION_ID=pvt.PROGRAM_VERSION_ID AND pvt.VERSION_STATUS_ID=@statusId WHERE pv.PROGRAM_ID=@programId and pv.VERSION_ID=@versionId;
    
    IF @statusId=1 THEN
        -- Final submitted
        -- ccList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID 
        FROM (
            SELECT u.USER_ID
            FROM vw_program p 
            LEFT JOIN us_user_acl acl ON 
                    (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
                    AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
                    AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
                    AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
            LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
            LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
            LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
            WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID='ROLE_BF_NOTIFICATION_CC_COMMIT' AND p.PROGRAM_ID=@programId AND u.ACTIVE

        UNION

            SELECT @committedId
        ) uCc
        LEFT JOIN us_user u ON uCc.USER_ID=u.USER_ID
        GROUP BY u.USER_ID;

    ELSEIF @statusId=2 THEN
        -- Approved
        -- ccList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID 
        FROM (
            SELECT u.USER_ID
            FROM vw_program p 
            LEFT JOIN us_user_acl acl ON 
                    (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
                    AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
                    AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
                    AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
            LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
            LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
            LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
            WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID='ROLE_BF_NOTIFICATION_CC_APPROVE' AND p.PROGRAM_ID=@programId AND u.ACTIVE

        UNION

            SELECT @approverId
        ) uCc
        LEFT JOIN us_user u ON uCc.USER_ID=u.USER_ID
        GROUP BY u.USER_ID;
    
    ELSEIF @statusId=3 THEN
        -- Rejected
        -- ccList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID 
        FROM (
            SELECT u.USER_ID
            FROM vw_program p 
            LEFT JOIN us_user_acl acl ON 
                    (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
                    AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
                    AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
                    AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
            LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
            LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
            LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
            WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID='ROLE_BF_NOTIFICATION_CC_REJECT' AND p.PROGRAM_ID=@programId AND u.ACTIVE

        UNION

            SELECT @approverId
        ) uCc
        LEFT JOIN us_user u ON uCc.USER_ID=u.USER_ID
        GROUP BY u.USER_ID;
    
    ELSEIF @statusId=4 THEN
        -- No review required
        -- ccList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID 
        FROM (
            SELECT u.USER_ID
            FROM vw_program p 
            LEFT JOIN us_user_acl acl ON 
                    (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
                    AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
                    AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
                    AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
            LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
            LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
            LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
            WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID='ROLE_BF_NOTIFICATION_CC_NOREVIEW' AND p.PROGRAM_ID=@programId AND u.ACTIVE

        UNION

            SELECT @approverId
        ) uCc
        LEFT JOIN us_user u ON uCc.USER_ID=u.USER_ID
        GROUP BY u.USER_ID;
    END IF; 
    
END$$

DELIMITER ;
;


USE `fasp`;
DROP procedure IF EXISTS `getSupplyPlanNotificationBccList`;

USE `fasp`;
DROP procedure IF EXISTS `fasp`.`getSupplyPlanNotificationBccList`;
;

DELIMITER $$
USE `fasp`$$
CREATE DEFINER=`faspUser`@`%` PROCEDURE `getSupplyPlanNotificationBccList`(VAR_PROGRAM_ID INT(10), VAR_VERSION_ID INT(10), VAR_STATUS_ID INT(10))
BEGIN 
    -- This SP is only called for Final Supply Plan submissions not for Draft
    SET @programId = VAR_PROGRAM_ID;
    SET @versionId = VAR_VERSION_ID;
    SET @statusId = VAR_STATUS_ID;
    -- statusId = 1 -> Final Submitted
    -- statusId = 2 -> Final Approved 
    -- statusId = 3 -> Final Rejected
    SELECT pv.CREATED_BY `COMMITTED_BY`, pvt.LAST_MODIFIED_BY INTO @committedId, @approverId FROM rm_program_version pv LEFT JOIN rm_program_version_trans pvt ON pv.PROGRAM_VERSION_ID=pvt.PROGRAM_VERSION_ID AND pvt.VERSION_STATUS_ID=@statusId WHERE pv.PROGRAM_ID=@programId and pv.VERSION_ID=@versionId;
    
    IF @statusId=1 THEN
        -- Final submitted
        -- bccList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID
        FROM vw_program p 
        LEFT JOIN us_user_acl acl ON 
            (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
            AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
            AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
            AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
        LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
        LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
        LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
        WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID IN ('ROLE_BF_NOTIFICATION_BCC_COMMIT') AND p.PROGRAM_ID=@programId AND u.ACTIVE 
        AND u.USER_ID NOT IN (
            SELECT u.USER_ID
            FROM vw_program p 
            LEFT JOIN us_user_acl acl ON 
                (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
                AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
                AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
                AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
            LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
            LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
            LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
            WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID IN ('ROLE_BF_NOTIFICATION_TO_COMMIT') AND p.PROGRAM_ID=@programId AND u.ACTIVE
            GROUP BY u.USER_ID
        )
        GROUP BY u.USER_ID;

    ELSEIF @statusId=2 THEN
        -- Approved
        -- bccList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID
        FROM vw_program p 
        LEFT JOIN us_user_acl acl ON 
            (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
            AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
            AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
            AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
        LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
        LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
        LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
        WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID IN ('ROLE_BF_NOTIFICATION_BCC_APPROVE') AND p.PROGRAM_ID=@programId AND u.ACTIVE AND u.USER_ID!=@committedId
        GROUP BY u.USER_ID;
    
    ELSEIF @statusId=3 THEN
        -- Rejected
        -- bccList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID
        FROM vw_program p 
        LEFT JOIN us_user_acl acl ON 
            (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
            AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
            AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
            AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
        LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
        LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
        LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
        WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID IN ('ROLE_BF_NOTIFICATION_BCC_REJECT') AND p.PROGRAM_ID=@programId AND u.ACTIVE AND u.USER_ID!=@committedId
        GROUP BY u.USER_ID;

    ELSEIF @statusId=4 THEN
        -- No review required
        -- bccList
        SELECT u.USER_ID, u.USERNAME, u.EMAIL_ID
        FROM vw_program p 
        LEFT JOIN us_user_acl acl ON 
            (acl.REALM_COUNTRY_ID is null OR acl.REALM_COUNTRY_ID=p.REALM_COUNTRY_ID)
            AND (acl.PROGRAM_ID is null OR acl.PROGRAM_ID=p.PROGRAM_ID)
            AND (acl.HEALTH_AREA_ID is null OR FIND_IN_SET(acl.HEALTH_AREA_ID,p.HEALTH_AREA_ID))
            AND (acl.ORGANISATION_ID is null OR acl.ORGANISATION_ID=p.ORGANISATION_ID)
        LEFT JOIN us_user u ON acl.USER_ID=u.USER_ID
        LEFT JOIN us_user_role ur ON u.USER_ID=ur.USER_ID 
        LEFT JOIN us_role_business_function rbf ON ur.ROLE_ID=rbf.ROLE_ID
        WHERE u.REALM_ID=1 AND rbf.BUSINESS_FUNCTION_ID IN ('ROLE_BF_NOTIFICATION_BCC_NOREVIEW') AND p.PROGRAM_ID=@programId AND u.ACTIVE AND u.USER_ID!=@committedId
        GROUP BY u.USER_ID;
    END IF; 
    
END$$

DELIMITER ;
;

